document.addEventListener("DOMContentLoaded",function(){function a(a){this.observer=this.bindObserver(a),this.peer=new webkitRTCPeerConnection({iceServers:j}),this.init(),this.getUserMedia()}function b(a){this.node=a,this.stub=document.createElement("li"),this.init()}function c(a){this.node=a,this.post=null,this.input=null,this.stub=null,this.isCompositing=!1,this.beforePost="",this.init()}function d(){this.uuid=[(65536*(1+Math.random())|0).toString(16).substring(1),(65536*(1+Math.random())|0).toString(16).substring(1),(65536*(1+Math.random())|0).toString(16).substring(1),(65536*(1+Math.random())|0).toString(16).substring(1),(65536*(1+Math.random())|0).toString(16).substring(1),(65536*(1+Math.random())|0).toString(16).substring(1),(65536*(1+Math.random())|0).toString(16).substring(1),(65536*(1+Math.random())|0).toString(16).substring(1)].join(""),this.init()}var e="ws://rtc.wnotes.net:8124",f=document,g=f.getElementById("remoteVideo"),h=f.getElementById("localVideo"),i=f.getElementById("members"),j=[{url:"stun:stun.l.google.com:19302"}],k=null,l=null,m=null,n="",o="",p={};p.onAddStream=function(a){console.log("Stream attached"),g.src=window.webkitURL.createObjectURL(a.stream)},p.onRemoveStream=function(){g.src=""},p.onNegotiationNeeded=function(){this.peer.createOffer(this.onLocalDescrion,this.errorHandler)},p.onIceCandidate=function(b){b.candidate&&websocket.send(JSON.stringify({candidate:b.candidate,type:a.MESSAGE_TYPE_CANDIDATE}))},p.onWebSocketMessage=function(b){var c,d,e=JSON.parse(b.data);switch(e.type){case a.MESSAGE_TYPE_SDP:if(c=new RTCSessionDescription(e.sdp),e.to&&e.to===o)switch(e.sdp_type){case a.DESCRIPTION_TYPE_OFFER:console.log("Remote description set"),console.dir(c),this.peer.setRemoteDescription(c,function(){this.createAnswer(e.from,e.sdp)}.bind(this));break;case a.DESCRIPTION_TYPE_ANSWER:console.log("Local description set"),console.dir(c),this.peer.setRemoteDescription(c),this.observer.onConnectionCompleted()}break;case a.MESSAGE_TYPE_CANDIDATE:e.candidate&&(d=new RTCIceCandidate(e.candidate),this.addIceCandidate(d));break;case a.MESSAGE_TYPE_CHAT:m.createPost(e.data,e.from===o);break;case a.MEMBER_ADDED:l.add(e.uuid,e.accessName);break;case a.MEMBER_REMOVED:l.remove(e.uuid)}},p.onConnectionCompleted=function(){console.log("Peer connection succeed!"),m.start(),g.volume=1,h.classList.add("connected")},p.onClosed=function(){g.stop(),h.classList.remove("connected")},a.DESCRIPTION_TYPE_OFFER="offer",a.DESCRIPTION_TYPE_ANSWER="answer",a.MESSAGE_TYPE_SDP="sdp",a.MESSAGE_TYPE_CONNECTION="connection",a.MESSAGE_TYPE_CANDIDATE="candidate",a.MESSAGE_TYPE_CHAT="chat",a.MEMBER_ADDED="member-added",a.MEMBER_REMOVED="member-removed",a.prototype.init=function(){this.peer.onicecandidate=this.observer.onIceCandidate,this.peer.onaddstream=this.observer.onAddStream,websocket.onmessage=this.observer.onWebSocketMessage},a.prototype.close=function(){this.peer.close(),this.obserber.onClosed()},a.prototype.bindObserver=function(a){var b=this;return Object.keys(a).forEach(function(c){a[c]=a[c].bind(b)}),a},a.prototype.addIceCandidate=function(a){this.peer.addIceCandidate(a)},a.prototype.createOffer=function(b){console.log("Offer send: "+b),this.peer.createOffer(function(c){this.peer.setLocalDescription(c,function(){websocket.send(JSON.stringify({type:a.MESSAGE_TYPE_SDP,sdp_type:a.DESCRIPTION_TYPE_OFFER,sdp:c,to:b,from:o}))})}.bind(this))},a.prototype.createAnswer=function(b){console.log("Answer send: "+b),this.peer.createAnswer(function(c){this.peer.setLocalDescription(c,function(){websocket.send(JSON.stringify({type:a.MESSAGE_TYPE_SDP,sdp_type:a.DESCRIPTION_TYPE_ANSWER,sdp:c,to:b,from:o}))}),this.observer.onConnectionCompleted()}.bind(this))},a.prototype.getUserMedia=function(){var a=this.peer;navigator.webkitGetUserMedia({audio:!0,video:!0},function(b){console.log("Media loaded"),h.src=window.webkitURL.createObjectURL(b),a.addStream(b)},this.errorHandler)},a.prototype.errorHandler=function(a){console.log(a.name+":"+a.message)},b.prototype.init=function(){this.node.addEventListener("click",function(a){var b;"LI"===a.target.tagName&&(b=a.target.getAttribute("data-uuid").slice(4),k.createOffer(b))},!1)},b.prototype.add=function(a,b){if(a!==o){var c=this.stub.cloneNode();c.setAttribute("data-uuid","uuid"+a),c.appendChild(document.createTextNode("member: "+b)),this.node.appendChild(c),c.classList.add("active")}},b.prototype.remove=function(a){var b=this.node.querySelector('[data-uuid="uuid'+a+'"]'),c=this.node;b&&(b.classList.remove("active"),setTimeout(function(){c.removeChild(b)},1e3))},c.prototype.init=function(){this.post=this.node.querySelector(".post"),this.input=this.node.querySelector("#chat"),this.stub=f.createElement("div"),this.input.addEventListener("keydown",this,!1),this.input.addEventListener("compositionstart",this,!1),this.input.addEventListener("compositionend",this,!1),this.input.disabled=!0},c.prototype.start=function(){this.input.disabled=!1,this.node.style.opacity=1},c.prototype.end=function(){this.input.disabled=!0,this.node.style.opacity=.2},c.prototype.handleEvent=function(b){var c;switch(b.type){case"keydown":if(27==b.keyCode){try{k.close()}catch(d){}return}if(c=this.input.value.trim(),""===c||this.isCompositing===!0||13!=b.keyCode)return;if(b.preventDefault(),c===this.beforePost)return console.log("同じ投稿はやめテ！"),void 0;this.beforePost=c,this.input.value="",websocket.send(JSON.stringify({type:a.MESSAGE_TYPE_CHAT,data:c,from:o}));break;case"compositionstart":this.isCompositing=!0;break;case"compositionend":this.isCompositing=!1}},c.prototype.createPost=function(a,b){var c=this.stub.cloneNode();b&&c.classList.add("self"),c.appendChild(f.createTextNode(a)),this.post.firstChild?this.post.insertBefore(c,this.post.firstChild):this.post.appendChild(c)},d.prototype.init=function(){var a=f.createElement("p"),b=f.getElementById("uuid");a.appendChild(f.createTextNode("Your Peer connection id:  "+this.uuid)),b.appendChild(a),b.classList.add("show")},d.prototype.toString=function(){return this.uuid};do n=prompt("Enter your access name");while(""===n);""===n&&(alert("Connected Canceled."),location.reload()),h.volume=0,g.volume=0,websocket=new WebSocket(e),k=new a(p),l=new b(i),m=new c(document.getElementById("chatSection")),o=new d+"",websocket.onopen=function(){websocket.send(JSON.stringify({type:a.MEMBER_ADDED,accessName:n,uuid:o}))},window.addEventListener("unload",function(){websocket.send(JSON.stringify({type:a.MEMBER_REMOVED,uuid:o}));try{k.close()}catch(b){}})},!1);